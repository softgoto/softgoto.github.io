---
title: 如何计算服务器能够承受多大的PV
date: 2020-12-30 16:49:51
categories: 技术类
tags:
- QPS
- 并发
---

### 前言

当业务方提出在某某时间需要做一个大型促销活动时，对于IT人员来说这个时间我们就需要评估系统能否抗住大促的压力，如果扛不住需要加多少服务器，带宽需要多少等问题都是需要我们评估的。

PV(访问量)：Page View


### QPS 计算模型

> 服务器每秒处理请求的数量 = ((80% \* 总访问量) / (24小时 \* 60分 \* 60秒 \* 40%)) / 服务器数量

<!--more-->

其中 `80%` 和 `40%` 意思是一天中有 `80%` 的请求发生在一天的 `40%` 的时间内。24小时的 `40%` 是 `9.6` 小时，有 `80%` 的请求发生一天的 `9.6` 个小时当中；

#### 简单计算

假设我们有一个大型促销活动要持续一整天，假设当天会有 `500万` 的访问量，我们来做个简单计算（一天我们按24小时计算）

((80% * 500万) / (24小时 * 60分 * 60秒 * 40%)) / 1 = 115.74个请求/秒

#### 初步结论

从上面公式计算得出，如果服务器一秒能处理 `115.74` 个请求，就可以承受 `500万访问量/天`。上面计算的请求量是均匀分布在 `9.6` 小时中，但实际情况请求肯定不会均匀分布的，会有高峰有低谷；为了应对高峰时段，应该留一些余地，最少也要 `x2` 倍，`x3` 倍也不夸张；

115.74个请求/秒 * 2倍 = 231.48个请求/秒

115.74个请求/秒 * 3倍 = 347.22个请求/秒

#### 最终结论

如果服务器一秒能处理 `231.48` 到 `347.22`个请求/秒，就可以承受平均 `500万/每天` 的访问量；后面根据一台服务器的实际压测情况再计算需要多少服务器。

假设实际压测目前一台服务器只能抗住 `100个请求/秒`，那么需要服务器的数量可以这样计算：

347.22 个请求/秒 / 100 个请求/秒 = 3.47 ≈ 4台服务器

> 前面说的每秒N个请求就是 `QPS`。因为我们关心的是应用程序每秒处理业务的能力。

### 带宽计算模型

一天总流量：(每个页面大小KB * 页面数量) / 1024 = MB

单位时间的流量：(MB / 时间) = MB每小时 / 3600 = MB/s * 1024 = KB/s

带宽计算：(KB/s * 8) / 1024 = mpbs

#### 简单计算

假设我们有 `1千万` 个页面或请求，平均每个页面或请求 `20KB`，时间我们约定每天 `8小时`，下面计算一下大概需要多大的带宽。

一天总流量：(20KB * 1千万) / 1024 = 195312.5MB

单位时间的流量：(195312.5MB / 8小时) = 24414.06MB每小时 / 3600 = 6.78MB/s * 1024 = 6944.44KB/s

带宽计算：(6944.44KB/s * 8) / 1024 = 54.25mpbs

> 1M带宽下载速度为 128KB/秒，注意大小写，b是位bit，B是字节Byte，1Byte = 8bit

如果请求是均匀分布的，就需要 `54.25M`（6944.44KB）带宽，但实际情况请求不可能是均匀分布的，当有高峰时 `54.25M` 带宽一定不够，`x2` 倍就是 `108.44M` 带宽，约等于一下 `100M` 带宽就可以满足要求。以上是假设每个页面 `20k` 字节，基本不包含图片，如果有图片或者视频就需要根据实际情况重新计算了。


Done. :coffee: